<div class="broadcast-container">
  <!-- Header Section -->
  <div class="broadcast-header">
    <div class="header-content">
      <div class="header-icon">üì¢</div>
      <div class="header-text">
        <h1>Crear Difusi√≥n</h1>
        <p>Env√≠a mensajes masivos a tus contactos de forma r√°pida y eficiente</p>
      </div>
    </div>
  </div>

  <!-- Main Form Card -->
  <div class="broadcast-card">
    <form [formGroup]="broadcastForm" (ngSubmit)="onSubmit()" class="broadcast-form" autocomplete="off">
      
      <!-- Step 1: Excel File Upload -->
      <div class="form-step">
        <div class="step-header">
          <span class="step-number">1</span>
          <h3>Archivo Excel de contactos</h3>
        </div>
        
        <div class="file-upload-area" [class.has-file]="excelFileName" [class.drag-over]="false">
          <input 
            id="excelFile" 
            type="file" 
            accept=".xlsx,.xls,.csv" 
            (change)="onExcelFileChange($event)"
            class="file-input"
          />
          <label for="excelFile" class="file-upload-label">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">
              <span class="upload-title">
                {{ excelFileName || 'Seleccionar archivo Excel' }}
              </span>
              <span class="upload-subtitle">
                Formatos soportados: .xlsx, .xls, .csv
              </span>
            </div>
            <div class="upload-actions">
              <button type="button" class="btn-sectorial-green upload-button">
                {{ excelFileName ? 'Cambiar archivo' : 'Examinar' }}
              </button>
              <button type="button" class="btn-sectorial-outline-green template-button" (click)="downloadTemplate()">
                üì• Descargar Plantilla
              </button>
            </div>
          </label>
        </div>
        
        <div class="file-requirements">
          <div class="requirement-item">
            <span class="requirement-icon">üìã</span>
            <span>El archivo debe tener columnas <strong>nombre</strong> y <strong>n√∫mero</strong></span>
          </div>
          <div class="requirement-item">
            <span class="requirement-icon">‚úÖ</span>
            <span>Tambi√©n acepta <strong>name</strong> y <strong>number</strong> en ingl√©s</span>
          </div>
          <div class="requirement-item template-info">
            <span class="requirement-icon">üí°</span>
            <span>¬øNo tienes un archivo? <strong>Descarga la plantilla</strong> con el formato correcto y ejemplos</span>
          </div>
        </div>

        <!-- File Status -->
        <div *ngIf="excelFileName && excelContacts.length === 0" class="file-status error">
          <span class="status-icon">‚ö†Ô∏è</span>
          <span>No se encontraron contactos v√°lidos en el archivo</span>
        </div>
      </div>

      <!-- Step 2: Contacts Preview -->
      <div class="form-step" *ngIf="excelContacts.length > 0">
        <div class="step-header">
          <span class="step-number">2</span>
          <h3>Contactos importados</h3>
          <span class="contacts-count">{{ excelContacts.length }} contactos</span>
        </div>
        
        <div class="contacts-preview">
          <div class="contacts-summary">
            <div class="summary-card">
              <div class="summary-icon">üë•</div>
              <div class="summary-info">
                <span class="summary-number">{{ excelContacts.length }}</span>
                <span class="summary-label">Contactos v√°lidos</span>
              </div>
            </div>
            <div class="summary-card" *ngIf="invalidPhones.length > 0">
              <div class="summary-icon">‚ö†Ô∏è</div>
              <div class="summary-info">
                <span class="summary-number">{{ invalidPhones.length }}</span>
                <span class="summary-label">N√∫meros inv√°lidos</span>
              </div>
            </div>
          </div>
          
          <div class="contacts-list-container">
            <div class="contacts-list">
              <div *ngFor="let contact of excelContacts.slice(0, 5); let i = index" class="contact-item">
                <div class="contact-avatar">{{ contact.name.charAt(0).toUpperCase() }}</div>
                <div class="contact-info">
                  <span class="contact-name">{{ contact.name }}</span>
                  <span class="contact-phone">{{ contact.number }}</span>
                </div>
              </div>
              <div *ngIf="excelContacts.length > 5" class="more-contacts">
                +{{ excelContacts.length - 5 }} contactos m√°s
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Message Content -->
      <div class="form-step">
        <div class="step-header">
          <span class="step-number">3</span>
          <h3>Contenido del mensaje</h3>
        </div>
        
        <div class="message-editor">
          <div class="editor-toolbar">
            <button type="button" class="btn-sectorial-green" (click)="insertVariable('{nombre}')">
              <span class="btn-icon">üë§</span>
              Insertar nombre
            </button>
            <div class="character-count">
              {{ broadcastForm.get('message')?.value?.length || 0 }}/1000
            </div>
          </div>
          
          <textarea 
            id="message" 
            formControlName="message" 
            class="message-textarea"
            placeholder="Escribe tu mensaje aqu√≠...&#10;&#10;Puedes usar {nombre} para personalizar el mensaje con el nombre de cada contacto.&#10;&#10;Ejemplo: Hola {nombre}, tenemos una oferta especial para ti..."
            rows="6"
          ></textarea>
          
          <div class="message-preview" *ngIf="broadcastForm.get('message')?.value && excelContacts.length > 0">
            <div class="preview-header">Vista previa:</div>
            <div class="preview-content">
              {{ getMessagePreview() }}
            </div>
          </div>
        </div>
        
        <div 
          class="field-error" 
          *ngIf="broadcastForm.get('message')?.hasError('required') && broadcastForm.get('message')?.touched"
        >
          El mensaje es requerido
        </div>
      </div>

      <!-- Step 4: Media Attachment -->
      <div class="form-step">
        <div class="step-header">
          <span class="step-number">4</span>
          <h3>Archivo multimedia <span class="optional">(opcional)</span></h3>
        </div>
        
        <div class="media-upload-area" [class.has-media]="mediaFileName">
          <input 
            id="mediaFile" 
            type="file" 
            accept="image/*,video/*" 
            (change)="onMediaFileChange($event)"
            class="file-input"
          />
          <label for="mediaFile" class="media-upload-label">
            <div class="media-icon">üñºÔ∏è</div>
            <div class="media-text">
              <span class="media-title">
                {{ mediaFileName || 'Adjuntar imagen o video' }}
              </span>
              <span class="media-subtitle">
                M√°ximo 10MB - JPG, PNG, MP4, etc.
              </span>
            </div>
            <div class="media-actions">
              <button type="button" class="btn-sectorial-green" *ngIf="!mediaFileName">
                Seleccionar
              </button>
              <button type="button" class="btn-sectorial-red" *ngIf="mediaFileName" (click)="removeMediaFile(); $event.preventDefault()">
                Quitar
              </button>
            </div>
          </label>
        </div>
      </div>

      <!-- Step 5: Schedule Options -->
      <div class="form-step">
        <div class="step-header">
          <span class="step-number">5</span>
          <h3>Opciones de env√≠o</h3>
        </div>
        
        <div class="schedule-options">
          <label class="schedule-toggle">
            <input type="checkbox" formControlName="schedule" class="toggle-input">
            <span class="toggle-slider"></span>
            <span class="toggle-label">Programar env√≠o</span>
          </label>
          
          <div *ngIf="broadcastForm.get('schedule')?.value" class="schedule-fields">
            <div class="schedule-info">
              <div class="timezone-info">
                <span class="timezone-icon">üåé</span>
                <span class="timezone-text">Hora de Colombia (GMT-5)</span>
              </div>
              <div class="current-time">
                Hora actual: {{ getCurrentColombiaTime() }}
              </div>
            </div>
            <div class="schedule-inputs">
              <div class="input-group">
                <label for="scheduleDate">üìÖ Fecha</label>
                <input 
                  type="date" 
                  id="scheduleDate" 
                  formControlName="scheduleDate"
                  [min]="today | date: 'yyyy-MM-dd'"
                  class="schedule-input"
                >
              </div>
              <div class="input-group">
                <label for="scheduleTime">üïê Hora</label>
                <input 
                  type="time" 
                  id="scheduleTime" 
                  formControlName="scheduleTime"
                  class="schedule-input"
                >
              </div>
            </div>
            <div class="schedule-preview" *ngIf="getSchedulePreview()">
              <span class="preview-label">Se enviar√°:</span>
              <span class="preview-time">{{ getSchedulePreview() }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <button 
          type="submit" 
          [disabled]="isSending || broadcastForm.invalid || excelContacts.length === 0"
          class="btn-sectorial-green submit-btn"
          [class.loading]="isSending"
        >
          <span class="btn-content">
            <span *ngIf="isSending" class="loading-spinner"></span>
            <span class="btn-icon" *ngIf="!isSending">üöÄ</span>
            <span class="btn-text">
              {{ getSubmitButtonText() }}
            </span>
          </span>
        </button>
        
        <div class="send-summary" *ngIf="excelContacts.length > 0 && !isSending">
          Se enviar√° a <strong>{{ excelContacts.length }}</strong> contactos
        </div>
      </div>
    </form>
  </div>

  <!-- Results Section -->
  <div *ngIf="showResults && broadcastResult" class="results-card">
    <div class="results-header">
      <div class="result-icon" [class.success]="broadcastResult.success" [class.error]="!broadcastResult.success">
        {{ getResultIcon() }}
      </div>
      <div class="result-title">
        {{ getResultTitle() }}
      </div>
    </div>
    
    <div class="result-message" [class.success]="broadcastResult.success" [class.error]="!broadcastResult.success">
      {{ broadcastResult.message }}
    </div>

    <!-- Additional Info for Scheduled Messages -->
    <div *ngIf="broadcastResult.success && isScheduledSend()" class="schedule-success-info">
      <div class="schedule-info-item">
        <span class="info-icon">üìÖ</span>
        <span class="info-text">
          <strong>Programado para:</strong> {{ getScheduledTimeFormatted() }}
        </span>
      </div>
      <div class="schedule-info-item">
        <span class="info-icon">üåé</span>
        <span class="info-text">
          <strong>Zona horaria:</strong> Colombia (GMT-5)
        </span>
      </div>
      <div class="schedule-info-item">
        <span class="info-icon">üì±</span>
        <span class="info-text">
          <strong>Contactos:</strong> {{ broadcastResult.total }} personas recibir√°n el mensaje
        </span>
      </div>
      <div class="schedule-info-item">
        <span class="info-icon">‚è∞</span>
        <span class="info-text">
          <strong>Estado:</strong> El env√≠o se ejecutar√° autom√°ticamente a la hora programada
        </span>
      </div>
    </div>

    <!-- Success message for immediate sends -->
    <div *ngIf="broadcastResult?.success && !isScheduledSend() && broadcastResult.total" class="immediate-success-info">
      <div class="success-summary">
        <div class="summary-item">
          <span class="summary-icon">üéâ</span>
          <span class="summary-text">
            ¬°Env√≠o completado exitosamente! Se enviaron <strong>{{ broadcastResult.sent }}</strong> 
            de <strong>{{ broadcastResult.total }}</strong> mensajes.
          </span>
        </div>
        <div *ngIf="broadcastResult.failed && broadcastResult.failed > 0" class="summary-item warning">
          <span class="summary-icon">‚ö†Ô∏è</span>
          <span class="summary-text">
            <strong>{{ broadcastResult.failed }}</strong> mensajes no pudieron ser enviados. 
            Puedes reintentar el env√≠o de los fallidos.
          </span>
        </div>
        <div class="summary-item">
          <span class="summary-icon">‚è±Ô∏è</span>
          <span class="summary-text">
            Enviado el {{ getCurrentColombiaTime() }}
          </span>
        </div>
      </div>
    </div>
    
    <div *ngIf="broadcastResult.results && broadcastResult.results.length > 0" class="results-details">
      <div class="results-summary">
        <div class="summary-stat">
          <div class="stat-number total">{{ broadcastResult.total }}</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="summary-stat">
          <div class="stat-number success">{{ broadcastResult.sent }}</div>
          <div class="stat-label">Enviados</div>
        </div>
        <div class="summary-stat">
          <div class="stat-number failed">{{ broadcastResult.failed }}</div>
          <div class="stat-label">Fallidos</div>
        </div>
      </div>
      
      <div class="results-list">
        <div class="results-list-header">
          <h4>Detalle de env√≠os</h4>
        </div>
        <div class="result-items">
          <div *ngFor="let result of broadcastResult.results" class="result-item" [class.failed]="result.status === 'failed'">
            <div class="result-status">
              <span class="status-icon">{{ result.status === 'sent' ? '‚úÖ' : '‚ùå' }}</span>
            </div>
            <div class="result-contact">
              <div class="contact-name">{{ result.name || 'Sin nombre' }}</div>
              <div class="contact-phone">{{ result.phone }}</div>
            </div>
            <div *ngIf="result.error" class="result-error">{{ result.error }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="results-actions">
      <button type="button" class="btn-sectorial-outline-green" (click)="showResults = false">
        Cerrar
      </button>
      <button 
        *ngIf="broadcastResult.failed && broadcastResult.failed > 0" 
        type="button" 
        class="btn-sectorial-red"
        (click)="retryFailed()"
      >
        üîÑ Reintentar fallidos
      </button>
      <button 
        type="button" 
        class="btn-sectorial-green"
        (click)="createNewBroadcast()"
      >
        ‚ú® Nueva Difusi√≥n
      </button>
    </div>
  </div>
</div>
